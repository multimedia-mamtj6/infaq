<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Info Tabung Bulanan MAMTJ6</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <!-- Adaptive Layout Styles -->
    <style>
        /* Fullscreen mode - original behavior */
        body.fullscreen-mode {
            height: 100vh;
            overflow: hidden;
        }

        body.fullscreen-mode .main-container {
            height: 100%;
        }

        /* Normal mode - allow scrolling */
        body.normal-mode {
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        body.normal-mode .main-container {
            min-height: 100vh;
            height: auto;
        }

        /* Smooth transitions */
        body {
            transition: height 0.3s ease;
        }

        /* Mobile/Tablet optimization */
        @media (max-width: 1023px) {
            body.normal-mode {
                overflow-y: auto;
            }

            body.normal-mode .flex-1.min-h-0 {
                min-height: auto;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-slate-900 flex flex-col items-center px-2 md:px-3 lg:px-4">

    <div class="main-container w-full flex flex-col items-center text-center">

        <!-- Logo -->
        <div class="flex-shrink-0 py-1 md:py-2">
            <img src="https://multimedia.mamtj6.com/media/logo/mamtj6-white.webp"
                 alt="Logo MAMTJ6"
                 class="h-12 md:h-14 lg:h-16 xl:h-20 w-auto object-contain">
        </div>

        <!-- Main Title -->
        <h1 class="text-white font-bold uppercase tracking-wide text-2xl md:text-4xl lg:text-5xl xl:text-6xl flex-shrink-0 pb-1 md:pb-2 lg:pb-3">
            Jumlah Kutipan Tabung
        </h1>

        <!-- Main Content: Top (Monthly Comparison) + Bottom (Yearly Chart) -->
        <div class="flex flex-col gap-1 md:gap-1.5 lg:gap-2 w-full flex-1 min-h-0">

            <!-- TOP SECTION: Monthly Comparison (Side by Side) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 md:gap-4 lg:gap-5 flex-1 min-h-0">

                <!-- Current Month (Bulan Ini) -->
                <div class="flex flex-col gap-1.5 md:gap-2 bg-white/5 backdrop-blur-sm rounded-xl p-2 md:p-3 shadow-xl border border-white/10 min-h-0">

                    <!-- Month Header -->
                    <h2 id="month-header-ini" class="font-bold uppercase text-center text-white text-xl md:text-2xl lg:text-3xl xl:text-4xl flex-shrink-0 py-2 md:py-3 lg:py-4">
                        Bulan Ini
                    </h2>

                    <!-- Weeks Container -->
                    <div id="weeks-container-ini" class="flex flex-col gap-1"></div>

                    <!-- Total Section (Emphasized for Current Month) -->
                    <div id="total-ini"
                         role="status"
                         aria-live="polite"
                         class="bg-slate-900 text-white rounded-lg font-bold text-center shadow-lg px-4 py-3 md:px-6 md:py-4 lg:px-8 lg:py-5 text-xl md:text-2xl lg:text-3xl xl:text-4xl flex-shrink-0">
                        RM 0.00
                    </div>
                </div>

                <!-- Previous Month (Bulan Lepas) -->
                <div class="flex flex-col gap-1.5 md:gap-2 bg-white/5 backdrop-blur-sm rounded-xl p-2 md:p-3 shadow-xl border border-white/10 min-h-0">

                    <!-- Month Header -->
                    <h2 id="month-header-lepas" class="font-bold uppercase text-center text-slate-300 text-xl md:text-2xl lg:text-3xl xl:text-4xl flex-shrink-0 py-2 md:py-3 lg:py-4">
                        Bulan Lepas
                    </h2>

                    <!-- Weeks Container -->
                    <div id="weeks-container-lepas" class="flex flex-col gap-1"></div>

                    <!-- Total Section (Regular for Previous Month) -->
                    <div id="total-lepas"
                         role="status"
                         aria-live="polite"
                         class="bg-slate-900 text-white rounded-lg font-bold text-center shadow-lg px-4 py-3 md:px-6 md:py-4 lg:px-8 lg:py-5 text-xl md:text-2xl lg:text-3xl xl:text-4xl flex-shrink-0">
                        RM 0.00
                    </div>
                </div>

            </div>

            <!-- BOTTOM SECTION: Yearly Performance Chart (Horizontal Full Width) -->
            <div class="flex flex-col gap-1 md:gap-1.5 bg-white/5 backdrop-blur-sm rounded-xl p-2 md:p-3 shadow-xl border border-white/10 h-40 md:h-48 lg:h-56 xl:h-64 flex-shrink-0 mt-1 md:mt-2 mb-1 md:mb-2">

                <!-- Chart Header with Yearly Total -->
                <div class="flex-shrink-0 flex flex-col sm:flex-row items-center justify-between gap-2 w-full">
                    <h2 class="font-bold uppercase text-center sm:text-left text-white text-xs md:text-sm lg:text-base flex items-center gap-1.5 flex-shrink-0">
                        <i class="ph-fill ph-trend-up text-xs md:text-sm"></i>
                        <span id="chart-year-label">Sumbangan Tahunan 2025</span>
                    </h2>

                    <!-- Yearly Total (Inline with header on larger screens) -->
                    <div id="total-yearly"
                         role="status"
                         aria-live="polite"
                         class="bg-gradient-to-r from-emerald-600 to-emerald-800 text-white rounded-lg font-bold text-center shadow-lg px-3 py-1.5 md:px-4 md:py-2 lg:px-5 lg:py-2.5 text-sm md:text-base lg:text-lg xl:text-xl flex items-center justify-center gap-1 overflow-hidden max-w-full sm:max-w-fit">
                        <i class="ph-fill ph-chart-line-up text-sm md:text-base flex-shrink-0"></i>
                        <span class="overflow-hidden text-ellipsis whitespace-nowrap">JUMLAH: RM 0.00</span>
                    </div>
                </div>

                <!-- Chart Canvas (Full Width, Horizontal) -->
                <div class="flex-1 min-h-0 w-full">
                    <canvas id="yearlyChart"></canvas>
                </div>

            </div>

        </div>

        <!-- Footer -->
        <div class="text-center text-white text-base md:text-lg lg:text-xl py-2 flex-shrink-0">
            Maklumat lanjut, layari <span class="font-bold text-yellow-400">infaq.mamtj6.com</span>
        </div>
    </div>

    <script>
        const jsonDataUrl = "https://raw.githubusercontent.com/multimedia-mamtj6/infaq/main/data/monthly.json";

        function formatCurrency(amount) {
            if (!amount || amount === 0) return "-";
            return `RM ${amount.toLocaleString('en-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Function to populate month data (Bulan Ini or Bulan Lepas)
        function populateMonthData(containerId, data) {
            const monthHeader = document.getElementById(`month-header-${containerId}`);
            const weeksContainer = document.getElementById(`weeks-container-${containerId}`);
            const totalSection = document.getElementById(`total-${containerId}`);

            if (!monthHeader || !weeksContainer || !totalSection) {
                console.error(`Elemen untuk ${containerId} tidak dijumpai.`);
                return;
            }

            if (!data) {
                // Update header text
                monthHeader.textContent = "TIADA DATA";
                weeksContainer.innerHTML = "";
                // Update total text
                totalSection.textContent = "-";
                return;
            }

            // Update month name
            monthHeader.textContent = data.Bulan;

            weeksContainer.innerHTML = ""; // Clear old data

            const weeksData = [
                { label: "MINGGU 1", value: data.Minggu1 },
                { label: "MINGGU 2", value: data.Minggu2 },
                { label: "MINGGU 3", value: data.Minggu3 },
                { label: "MINGGU 4", value: data.Minggu4 },
                { label: "MINGGU 5", value: data.Minggu5 }
            ];

            weeksData.forEach((week, index) => {
                const weekDiv = document.createElement("div");

                // Alternating colors: odd rows (1,3,5) = blue bg, even rows (2,4) = white bg
                const isOdd = (index + 1) % 2 === 1;
                const bgColor = isOdd ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-blue-700 shadow-sm border border-slate-200';

                weekDiv.className = `flex justify-between items-center rounded-lg font-semibold px-3 py-2 md:px-4 md:py-3 lg:px-6 lg:py-4 text-lg md:text-xl lg:text-2xl xl:text-3xl ${bgColor}`;

                weekDiv.innerHTML = `
                    <span>${week.label}</span>
                    <span class="font-bold">${formatCurrency(week.value)}</span>
                `;

                weeksContainer.appendChild(weekDiv);
            });

            // Update total
            totalSection.textContent = `JUMLAH: ${formatCurrency(data.JumlahBulanan)}`;
        }

        // Chart instance (global to destroy on refresh)
        let yearlyChartInstance = null;

        // Function to render yearly chart
        function renderYearlyChart(grafData) {
            const canvas = document.getElementById('yearlyChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Get current year data (assumes latest year in grafData)
            const years = Object.keys(grafData || {});
            const currentYear = years.length > 0 ? years[years.length - 1] : new Date().getFullYear().toString();
            const yearData = grafData[currentYear] || { labels: [], data: [] };

            // Update year label
            const yearLabel = document.getElementById('chart-year-label');
            if (yearLabel) yearLabel.textContent = `Sumbangan Tahunan ${currentYear}`;

            // Calculate yearly total
            const yearlyTotal = yearData.data.reduce((sum, val) => sum + (val || 0), 0);
            const totalYearlyElement = document.getElementById('total-yearly');
            if (totalYearlyElement) {
                const span = totalYearlyElement.querySelector('span');
                if (span) span.innerHTML = `<span class="font-normal">Jumlah Terkumpul Untuk Tahun Ini:</span> ${formatCurrency(yearlyTotal)}`;
            }

            // Destroy existing chart if any
            if (yearlyChartInstance) {
                yearlyChartInstance.destroy();
            }

            // Create new chart
            yearlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: yearData.labels || [],
                    datasets: [{
                        label: 'Kutipan Bulanan (RM)',
                        data: yearData.data || [],
                        // Line styling
                        borderColor: 'rgba(16, 185, 129, 1)', // emerald-600
                        borderWidth: 3,
                        // Fill under the line with gradient
                        fill: true,
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, context.chart.height);
                            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); // emerald-600 at 50% opacity
                            gradient.addColorStop(1, 'rgba(16, 185, 129, 0)'); // fade to transparent
                            return gradient;
                        },
                        // Smooth curve
                        tension: 0.4,
                        // Point styling
                        pointBackgroundColor: 'rgba(16, 185, 129, 1)', // emerald-600
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointHoverBackgroundColor: 'rgba(5, 150, 105, 1)', // emerald-700
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)', // slate-900
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 12,
                            borderColor: 'rgba(148, 163, 184, 0.3)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                font: {
                                    size: 9,
                                    family: 'Inter'
                                },
                                callback: function(value) {
                                    return 'RM ' + value.toLocaleString('en-MY');
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                font: {
                                    size: 20,
                                    family: 'Inter',
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        async function fetchDataAndUpdate() {
            try {
                const response = await fetch(`${jsonDataUrl}?t=${new Date().getTime()}`);
                const fullData = await response.json();

                // Populate monthly sections
                populateMonthData('ini', fullData.paparanBulanIni);
                populateMonthData('lepas', fullData.paparanBulanLepas);

                // Render yearly chart
                if (fullData.graf) {
                    renderYearlyChart(fullData.graf);
                }

            } catch (error) {
                console.error("Ralat memuatkan data:", error);
                // Display error on both sections if fetch fails
                const headerIni = document.getElementById('month-header-ini').querySelector('span');
                const headerLepas = document.getElementById('month-header-lepas').querySelector('span');
                if (headerIni) headerIni.textContent = "RALAT DATA";
                if (headerLepas) headerLepas.textContent = "RALAT DATA";
            }
        }

        // Fetch data on page load
        fetchDataAndUpdate();

        // Auto-refresh every 5 minutes
        setInterval(fetchDataAndUpdate, 300000);

        // Detect fullscreen vs normal mode for adaptive layout
        function detectViewportMode() {
            const isFullscreen = window.innerHeight >= 900; // Threshold for "fullscreen-like"
            const body = document.body;

            if (isFullscreen) {
                // Fullscreen mode: lock to viewport
                body.classList.add('fullscreen-mode');
                body.classList.remove('normal-mode');
            } else {
                // Normal mode: allow scrolling
                body.classList.remove('fullscreen-mode');
                body.classList.add('normal-mode');
            }
        }

        // Run on load and resize
        window.addEventListener('load', detectViewportMode);
        window.addEventListener('resize', detectViewportMode);
    </script>
</body>
</html>
